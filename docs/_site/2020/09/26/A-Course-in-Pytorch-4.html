<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>A course in pytorch 4</title>
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Your awesome title" />
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>A course in pytorch 4 | Your awesome title</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="A course in pytorch 4" />
<meta name="author" content="rym" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Pytorch 入门 本文翻译自pytorch官方教程DEEP LEARNING WITH PYTORCH: A 60 MINUTE BLITZ，共四篇。 这是第四篇TRAINING A CLASSIFIER." />
<meta property="og:description" content="Pytorch 入门 本文翻译自pytorch官方教程DEEP LEARNING WITH PYTORCH: A 60 MINUTE BLITZ，共四篇。 这是第四篇TRAINING A CLASSIFIER." />
<link rel="canonical" href="http://localhost:4000/2020/09/26/A-Course-in-Pytorch-4.html" />
<meta property="og:url" content="http://localhost:4000/2020/09/26/A-Course-in-Pytorch-4.html" />
<meta property="og:site_name" content="Your awesome title" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-09-26T00:00:00+08:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","url":"http://localhost:4000/2020/09/26/A-Course-in-Pytorch-4.html","headline":"A course in pytorch 4","datePublished":"2020-09-26T00:00:00+08:00","dateModified":"2020-09-26T00:00:00+08:00","author":{"@type":"Person","name":"rym"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/09/26/A-Course-in-Pytorch-4.html"},"description":"Pytorch 入门 本文翻译自pytorch官方教程DEEP LEARNING WITH PYTORCH: A 60 MINUTE BLITZ，共四篇。 这是第四篇TRAINING A CLASSIFIER.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <body>
    <nav>
  
    <a href="/" >Home</a>
  
    <a href="/about.html" >About</a>
  
    <a href="/blog.html" >Blog</a>
  
    <a href="/staff.html" >Staff</a>
  
</nav>
    <h1>A course in pytorch 4</h1>

<p>
  26 Sep 2020
  
  
    - <a href="/authors/rym.html">任雨濛</a>
  
</p>

<h1 id="pytorch-入门">Pytorch 入门</h1>

<blockquote>
  <p>本文翻译自pytorch官方教程<a href="https://pytorch.org/tutorials/beginner/deep_learning_60min_blitz.html">DEEP LEARNING WITH PYTORCH: A 60 MINUTE BLITZ</a>，共四篇。
这是第四篇TRAINING A CLASSIFIER.</p>
</blockquote>

<!-- more -->

<h1 id="training-a-classifier训练分类器">Training A Classifier训练分类器</h1>

<p>现在，你知道如何定义神经网络，计算损失(loss)，以及更新权重(weight)。现在该考虑一下数据(data)的问题了。</p>

<h2 id="what-about-data">What about data?</h2>

<p>一般来说，处理图片、声音、文本和视频，你可以使用python的标准包来导入，转化为numpy，再变成pytorch中不同种类的张量(torch.*Tensor)。</p>

<p>对于图片，可以用Pillow, OpenCV;
对于音频，可以用scipy和librosa;
对于文本，可以用Python或Cython原生函数或者NLTK和SaCy。</p>

<p>特别对于计算机视觉(vision)，我们已经制作了torchvision包，报扩常用数据集(dataset)如Imagenet, CIFAR10, MNIST等等的加载器(dataloader)和对图像的处理器(transformer)。以上功能通过torchvision.datasets 和torch.utils.data.Dataloader实现。</p>

<p>这提供了巨大的便利，避免重复造轮子。</p>

<p>对于这个教程，我们使用 CIFAR10数据集。它包含以下类别的图片：‘airplane’, ‘automobile’, ‘bird’, ‘cat’, ‘deer’, ‘dog’, ‘frog’, ‘horse’, ‘ship’, ‘truck’。其中的图片是3x32x32的，即三通道颜色(RGB)，长宽各32像素(pixel)。</p>

<p><img src="http://localhost:4000/\assets\image\2020-09-26-A-Course-in-Pytorch-4\cifar10.png" alt="cifar10" /></p>

<h2 id="训练一个分类器">训练一个分类器=</h2>

<p>我们将依次进行以下几个步骤：</p>

<ul>
  <li>使用torchvision加载并归一化 CIFAR10的训练集(training dataset)和测试集(test dataset)。</li>
  <li>定义CNN(卷积神经网络, Convolutional Neural Network)</li>
  <li>定义损失函数</li>
  <li>在训练集上训练网络</li>
  <li>在测试集上测试网络</li>
</ul>

<h3 id="loading-and-normalizing-cifar10">Loading and normalizing CIFAR10</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="n">transforms</span>
<span class="n">The</span> <span class="n">output</span> <span class="n">of</span> <span class="n">torchvision</span> <span class="n">datasets</span> <span class="n">are</span> <span class="n">PILImage</span> <span class="n">images</span> <span class="n">of</span> <span class="nb">range</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span> <span class="n">We</span> <span class="n">transform</span> <span class="n">them</span> <span class="n">to</span> <span class="n">Tensors</span> <span class="n">of</span> <span class="n">normalized</span> <span class="nb">range</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">].</span> <span class="p">..</span> <span class="n">note</span><span class="p">:</span>

<span class="n">If</span> <span class="n">running</span> <span class="n">on</span> <span class="n">Windows</span> <span class="ow">and</span> <span class="n">you</span> <span class="n">get</span> <span class="n">a</span> <span class="nb">BrokenPipeError</span><span class="p">,</span> <span class="k">try</span> <span class="n">setting</span>
<span class="n">the</span> <span class="n">num_worker</span> <span class="n">of</span> <span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">DataLoader</span><span class="p">()</span> <span class="n">to</span> <span class="mf">0.</span>
<span class="n">transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">(</span>
    <span class="p">[</span><span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">(),</span>
     <span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))])</span>

<span class="n">trainset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">datasets</span><span class="p">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s">'./data'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                        <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="n">trainloader</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">trainset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                          <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">testset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="p">.</span><span class="n">datasets</span><span class="p">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s">'./data'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                       <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="n">testloader</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">testset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                         <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">classes</span> <span class="o">=</span> <span class="p">(</span><span class="s">'plane'</span><span class="p">,</span> <span class="s">'car'</span><span class="p">,</span> <span class="s">'bird'</span><span class="p">,</span> <span class="s">'cat'</span><span class="p">,</span>
           <span class="s">'deer'</span><span class="p">,</span> <span class="s">'dog'</span><span class="p">,</span> <span class="s">'frog'</span><span class="p">,</span> <span class="s">'horse'</span><span class="p">,</span> <span class="s">'ship'</span><span class="p">,</span> <span class="s">'truck'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">Out</span>:

<span class="kd">Downloading</span> <span class="kd">https</span>://www.cs.toronto.edu/<span class="o">~</span><span class="kd">kriz</span><span class="na">/cifar</span><span class="o">-</span><span class="m">10</span><span class="na">-python</span>.tar.gz <span class="kd">to</span> ./data/cifar<span class="o">-</span><span class="m">10</span><span class="na">-python</span>.tar.gz
<span class="kd">Extracting</span> ./data/cifar<span class="o">-</span><span class="m">10</span><span class="na">-python</span>.tar.gz <span class="kd">to</span> ./data
<span class="kd">Files</span> <span class="kd">already</span> <span class="kd">downloaded</span> <span class="kd">and</span> <span class="kd">verified</span>
</code></pre></div></div>

<p>让我们显示一些图片：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="c1"># functions to show an image
</span>

<span class="k">def</span> <span class="nf">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span>     <span class="c1"># unnormalize
</span>    <span class="n">npimg</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">npimg</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># get some random training images
</span><span class="n">dataiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">trainloader</span><span class="p">)</span>
<span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">dataiter</span><span class="p">.</span><span class="nb">next</span><span class="p">()</span>

<span class="c1"># show images
</span><span class="n">imshow</span><span class="p">(</span><span class="n">torchvision</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">make_grid</span><span class="p">(</span><span class="n">images</span><span class="p">))</span>
<span class="c1"># print labels
</span><span class="k">print</span><span class="p">(</span><span class="s">' '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">'%5s'</span> <span class="o">%</span> <span class="n">classes</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
</code></pre></div></div>

<p><img src="http://localhost:4000/\assets\image\2020-09-26-A-Course-in-Pytorch-4\one-pic-in-cifar10.png" alt="one-pic-in-cifar10" /></p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">Out</span>:

<span class="kd">ship</span>  <span class="kd">bird</span> <span class="kd">plane</span> <span class="kd">truck</span>
</code></pre></div></div>

<h3 id="定义一个cnn">定义一个CNN</h3>

<p>从上一篇文章（神经网络）中复制代码，改动它使能处理3通道图片（之前是1通道）。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="n">F</span>


<span class="k">class</span> <span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">120</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">84</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fc3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">pool</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">pool</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fc3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>


<span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="define-a-loss-function-and-optimizer">Define a Loss function and optimizer</h3>

<p>用分类的交叉熵来定义损失函数，以及带动量的随机梯度下降法。(Let’s use a Classification Cross-Entropy loss and SGD with momentum.)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>

<span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">net</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
<span class="mf">4.</span> <span class="n">Train</span> <span class="n">the</span> <span class="n">network</span>
<span class="n">This</span> <span class="ow">is</span> <span class="n">when</span> <span class="n">things</span> <span class="n">start</span> <span class="n">to</span> <span class="n">get</span> <span class="n">interesting</span><span class="p">.</span> <span class="n">We</span> <span class="n">simply</span> <span class="n">have</span> <span class="n">to</span> <span class="n">loop</span> <span class="n">over</span> <span class="n">our</span> <span class="n">data</span> <span class="n">iterator</span><span class="p">,</span> <span class="ow">and</span> <span class="n">feed</span> <span class="n">the</span> <span class="n">inputs</span> <span class="n">to</span> <span class="n">the</span> <span class="n">network</span> <span class="ow">and</span> <span class="n">optimize</span><span class="p">.</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># loop over the dataset multiple times
</span>
    <span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">trainloader</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># get the inputs; data is a list of [inputs, labels]
</span>        <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># zero the parameter gradients
</span>        <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>

        <span class="c1"># forward + backward + optimize
</span>        <span class="n">outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
        <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># print statistics
</span>        <span class="n">running_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="p">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2000</span> <span class="o">==</span> <span class="mi">1999</span><span class="p">:</span>    <span class="c1"># print every 2000 mini-batches
</span>            <span class="k">print</span><span class="p">(</span><span class="s">'[%d, %5d] loss: %.3f'</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">running_loss</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">))</span>
            <span class="n">running_loss</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Finished Training'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">Out</span>:

<span class="o">[</span><span class="m">1</span><span class="o">,</span>  <span class="m">2000</span><span class="o">]</span> <span class="kd">loss</span>: <span class="m">2</span>.182
<span class="o">[</span><span class="m">1</span><span class="o">,</span>  <span class="m">4000</span><span class="o">]</span> <span class="kd">loss</span>: <span class="m">1</span>.805
<span class="o">[</span><span class="m">1</span><span class="o">,</span>  <span class="m">6000</span><span class="o">]</span> <span class="kd">loss</span>: <span class="m">1</span>.645
<span class="o">[</span><span class="m">1</span><span class="o">,</span>  <span class="m">8000</span><span class="o">]</span> <span class="kd">loss</span>: <span class="m">1</span>.591
<span class="o">[</span><span class="m">1</span><span class="o">,</span> <span class="m">10000</span><span class="o">]</span> <span class="kd">loss</span>: <span class="m">1</span>.515
<span class="o">[</span><span class="m">1</span><span class="o">,</span> <span class="m">12000</span><span class="o">]</span> <span class="kd">loss</span>: <span class="m">1</span>.481
<span class="o">[</span><span class="m">2</span><span class="o">,</span>  <span class="m">2000</span><span class="o">]</span> <span class="kd">loss</span>: <span class="m">1</span>.411
<span class="o">[</span><span class="m">2</span><span class="o">,</span>  <span class="m">4000</span><span class="o">]</span> <span class="kd">loss</span>: <span class="m">1</span>.403
<span class="o">[</span><span class="m">2</span><span class="o">,</span>  <span class="m">6000</span><span class="o">]</span> <span class="kd">loss</span>: <span class="m">1</span>.339
<span class="o">[</span><span class="m">2</span><span class="o">,</span>  <span class="m">8000</span><span class="o">]</span> <span class="kd">loss</span>: <span class="m">1</span>.356
<span class="o">[</span><span class="m">2</span><span class="o">,</span> <span class="m">10000</span><span class="o">]</span> <span class="kd">loss</span>: <span class="m">1</span>.312
<span class="o">[</span><span class="m">2</span><span class="o">,</span> <span class="m">12000</span><span class="o">]</span> <span class="kd">loss</span>: <span class="m">1</span>.304
<span class="kd">Finished</span> <span class="kd">Training</span>
</code></pre></div></div>

<p>保存训练完成的模型。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">PATH</span> <span class="o">=</span> <span class="s">'./cifar_net.pth'</span>
<span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">net</span><span class="p">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">PATH</span><span class="p">)</span>
</code></pre></div></div>

<p>更多<a href="https://pytorch.org/docs/stable/notes/serialization.html">关于保存的细节</a>。</p>

<h3 id="test-the-network-on-the-test-data">Test the network on the test data</h3>

<p>我们在训练集上训练(train)网络两遍。我们将在测试集上用神经网络预测(predict)图片的分类(label)，和真正分类(ground-truth)对比。如果正确，就把该样本(sample)加入正确预测的列表里。这样就能看出神经网络是否真的学到了什么。</p>

<p>展示测试集的一张图。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dataiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">testloader</span><span class="p">)</span>
<span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">dataiter</span><span class="p">.</span><span class="nb">next</span><span class="p">()</span>

<span class="c1"># print images
</span><span class="n">imshow</span><span class="p">(</span><span class="n">torchvision</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">make_grid</span><span class="p">(</span><span class="n">images</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'GroundTruth: '</span><span class="p">,</span> <span class="s">' '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">'%5s'</span> <span class="o">%</span> <span class="n">classes</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
</code></pre></div></div>

<p><img src="http://localhost:4000/assets/image/2020-09-26-A-Course-in-Pytorch-4/one-pic-in-test.png" alt="one-pic-in-test" /></p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">Out</span>:

<span class="kd">GroundTruth</span>:    <span class="kd">cat</span>  <span class="kd">ship</span>  <span class="kd">ship</span> <span class="kd">plane</span>
</code></pre></div></div>

<p>我们加载训练好的模型（并非必要，只是展示加载方法）：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">net</span> <span class="o">=</span> <span class="n">Net</span><span class="p">()</span>
<span class="n">net</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">PATH</span><span class="p">))</span>
</code></pre></div></div>

<p>现在预测：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
</code></pre></div></div>

<p>输出是图片在10类上的能量(机率)，因此取最高作为预测分类：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Predicted: '</span><span class="p">,</span> <span class="s">' '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">'%5s'</span> <span class="o">%</span> <span class="n">classes</span><span class="p">[</span><span class="n">predicted</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
                              <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>

</code></pre></div></div>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">Out</span>:

<span class="kd">Predicted</span>:    <span class="kd">cat</span>   <span class="kd">car</span> <span class="kd">plane</span> <span class="kd">plane</span>
</code></pre></div></div>

<p>看起来不错。下面在整个测试集上预测。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">testloader</span><span class="p">:</span>
        <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">).</span><span class="nb">sum</span><span class="p">().</span><span class="n">item</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Accuracy of the network on the 10000 test images: %d %%'</span> <span class="o">%</span> <span class="p">(</span>
    <span class="mi">100</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">Out</span>:

<span class="kd">Accuracy</span> <span class="kd">of</span> <span class="kd">the</span> <span class="kd">network</span> <span class="na">on</span> <span class="kd">the</span> <span class="m">10000</span> <span class="kd">test</span> <span class="kd">images</span>: <span class="m">54</span> <span class="err">%</span>
</code></pre></div></div>

<p>这看起来比随机选择要好，神经网络确实学到了东西。</p>

<p>下面看看在各个类上的预测表现。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">class_correct</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="n">class_total</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">testloader</span><span class="p">:</span>
        <span class="n">images</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">net</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">).</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">class_correct</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">item</span><span class="p">()</span>
            <span class="n">class_total</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Accuracy of %5s : %2d %%'</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">class_correct</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">class_total</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

</code></pre></div></div>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">Out</span>:

<span class="kd">Accuracy</span> <span class="kd">of</span> <span class="kd">plane</span> : <span class="m">63</span> <span class="err">%</span>
<span class="kd">Accuracy</span> <span class="kd">of</span>   <span class="kd">car</span> : <span class="m">69</span> <span class="err">%</span>
<span class="kd">Accuracy</span> <span class="kd">of</span>  <span class="kd">bird</span> : <span class="m">51</span> <span class="err">%</span>
<span class="kd">Accuracy</span> <span class="kd">of</span>   <span class="kd">cat</span> : <span class="m">46</span> <span class="err">%</span>
<span class="kd">Accuracy</span> <span class="kd">of</span>  <span class="kd">deer</span> : <span class="m">34</span> <span class="err">%</span>
<span class="kd">Accuracy</span> <span class="kd">of</span>   <span class="kd">dog</span> : <span class="m">42</span> <span class="err">%</span>
<span class="kd">Accuracy</span> <span class="kd">of</span>  <span class="kd">frog</span> : <span class="m">70</span> <span class="err">%</span>
<span class="kd">Accuracy</span> <span class="kd">of</span> <span class="kd">horse</span> : <span class="m">53</span> <span class="err">%</span>
<span class="kd">Accuracy</span> <span class="kd">of</span>  <span class="kd">ship</span> : <span class="m">57</span> <span class="err">%</span>
<span class="kd">Accuracy</span> <span class="kd">of</span> <span class="kd">truck</span> : <span class="m">53</span> <span class="err">%</span>
</code></pre></div></div>

<h3 id="training-on-gpu">Training on GPU</h3>

<p>就像把一个张量转移到GPU，我们可以把整个网络转移。</p>

<p>我们先定义GPU设备为第一个可见GPU设备（0号设备），如果cuda可用。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="s">"cuda:0"</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s">"cpu"</span><span class="p">)</span>

<span class="c1"># Assuming that we are on a CUDA machine, this should print a CUDA device:
</span>
<span class="k">print</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">Out</span>:

<span class="kd">cuda</span>:0
</code></pre></div></div>

<p>之后默认使用这个设备。</p>

<p>这些函数会递归地把所有变量和缓存转移到设备上：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">net</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></div>

<p>同样，每步的输入和目标也要转移：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="对比cpu为啥看不出加速效果">对比CPU，为啥看不出加速效果？</h3>

<p>你的网络太小了。</p>

<p>一个练习：增加网络的宽度(width) (第一个nn.Conv2d的参数2,和第二个Conv2d的参数1——它们是相同的数)，看看加速效果。</p>

<p>现在，教程的目的达到了：</p>

<ul>
  <li>
    <p>整体上理解pytorch的张量库和神经网络。</p>
  </li>
  <li>
    <p>训练一个小网络来分类图片。</p>
  </li>
</ul>

<h3 id="多gpu训练">多GPU训练</h3>

<p>详见<a href="https://pytorch.org/tutorials/beginner/blitz/data_parallel_tutorial.html">Data Parallelism</a>.</p>

  </body>
</html>